# 소상공인시장진흥공단 상가(상권)정보 배치 프로젝트

## Table of Contents
1. [소개](#소개)
2. [실행환경](#실행환경)
3. [설치](#설치)
4. [선행설정](#선행설정)
5. [실행방법](#실행방법)


## 소개
이 프로젝트는 소상공인진흥공단에서 제공하는 상가(상권)정보 CSV파일을 읽어서 데이터베이스로 삽입하는 프로젝트입니다.


## 실행환경
- JDK 17
- Gradle 8.8
- Spring Boot 3.3.1
- Spring Framework 6.1.10
- Spring Batch 5.1.2

## 설치
- 프로젝트 클론
```sh
git clone https://github.com/your-username/spring-batch-project.git
cd spring-batch-project
git checkout master
```
- 프로젝트 빌드
```sh
./gradlew clean build
```

## 선행설정
- mysql 데이터베이스의 설정을 application.properties에 입력해주세요.
- assignment 데이터베이스는 아래 sql에서 생성하도록 되어있습니다.
  기본으로 설정되어있는 application.yaml의 database.url에서
  database이름인 assignment는 변경하시면 안됩니다.
- 데이터베이스 및 두개 테이블을 미리 생성해주셔야 합니다. 아래 sql을 실행하시면 됩니다.

<details>
<summary>sql 접기/펼치기</summary>

```sh
CREATE DATABASE IF NOT EXISTS assignment;
USE assignment;
CREATE TABLE store_info (
    store_code VARCHAR(40) PRIMARY KEY COMMENT "상가업소번호",
    store_name VARCHAR(255) NOT NULL COMMENT "상호명",
    branch_name VARCHAR(255) COMMENT "지점명",
    large_category_code VARCHAR(10) COMMENT "상권업종대분류코드",
    large_category_name VARCHAR(50) COMMENT "상권업종대분류명",
    medium_category_code VARCHAR(10) COMMENT "상권업종중분류코드",
    medium_category_name VARCHAR(50) COMMENT "상권업종중분류명",
    small_category_code VARCHAR(10) COMMENT "상권업종소분류코드",
    small_category_name VARCHAR(50) COMMENT "상권업종소분류명",
    standard_industry_code VARCHAR(10) COMMENT "표준산업분류코드",
    standard_industry_name VARCHAR(255) COMMENT "표준산업분류명",
    si_do_code VARCHAR(10) COMMENT "시도코드",
    si_do_name VARCHAR(50) COMMENT "시도명",
    si_gun_gu_code VARCHAR(10) COMMENT "시군구코드",
    si_gun_gu_name VARCHAR(50) COMMENT "시군구명",
    administrative_dong_code VARCHAR(10) COMMENT "행정동코드",
    administrative_dong_name VARCHAR(50) COMMENT "행정동명",
    legal_dong_code VARCHAR(10) COMMENT "법정동코드",
    legal_dong_name VARCHAR(50) COMMENT "법정동명",
    lot_number_code VARCHAR(25) COMMENT "지번코드",
    land_division_code VARCHAR(10) COMMENT "대지구분코드",
    land_division_name VARCHAR(50) COMMENT "대지구분명",
    lot_main_number INT COMMENT "지번본번",
    lot_sub_number INT COMMENT "지번부번",
    lot_address VARCHAR(255) COMMENT "지번주소",
    road_name_code VARCHAR(15) COMMENT "도로명코드",
    road_name VARCHAR(255) COMMENT "도로명",
    building_main_number INT COMMENT "건물본번지",
    building_sub_number INT COMMENT "건물부번지",
    building_management_number VARCHAR(50) COMMENT "건물관리번호",
    building_name VARCHAR(255) COMMENT "건물명",
    road_name_address VARCHAR(255) COMMENT "도로명주소",
    old_postal_code VARCHAR(10) COMMENT "구우편번호",
    new_postal_code VARCHAR(10) COMMENT "신우편번호",
    dong_info VARCHAR(50) COMMENT "동정보",
    floor_info VARCHAR(10) COMMENT "층정보",
    room_info VARCHAR(10) COMMENT "호정보",
    longitude DOUBLE COMMENT "경도",
    latitude DOUBLE COMMENT "위도"
);

-- Autogenerated: do not edit this file

CREATE TABLE BATCH_JOB_INSTANCE  (
                                     JOB_INSTANCE_ID BIGINT  NOT NULL PRIMARY KEY ,
                                     VERSION BIGINT ,
                                     JOB_NAME VARCHAR(100) NOT NULL,
                                     JOB_KEY VARCHAR(32) NOT NULL,
                                     constraint JOB_INST_UN unique (JOB_NAME, JOB_KEY)
) ENGINE=InnoDB;

CREATE TABLE BATCH_JOB_EXECUTION  (
                                      JOB_EXECUTION_ID BIGINT  NOT NULL PRIMARY KEY ,
                                      VERSION BIGINT  ,
                                      JOB_INSTANCE_ID BIGINT NOT NULL,
                                      CREATE_TIME DATETIME(6) NOT NULL,
                                      START_TIME DATETIME(6) DEFAULT NULL ,
                                      END_TIME DATETIME(6) DEFAULT NULL ,
                                      STATUS VARCHAR(10) ,
                                      EXIT_CODE VARCHAR(2500) ,
                                      EXIT_MESSAGE VARCHAR(2500) ,
                                      LAST_UPDATED DATETIME(6),
                                      constraint JOB_INST_EXEC_FK foreign key (JOB_INSTANCE_ID)
                                          references BATCH_JOB_INSTANCE(JOB_INSTANCE_ID)
) ENGINE=InnoDB;

CREATE TABLE BATCH_JOB_EXECUTION_PARAMS  (
                                             JOB_EXECUTION_ID BIGINT NOT NULL ,
                                             PARAMETER_NAME VARCHAR(100) NOT NULL ,
                                             PARAMETER_TYPE VARCHAR(100) NOT NULL ,
                                             PARAMETER_VALUE VARCHAR(2500) ,
                                             IDENTIFYING CHAR(1) NOT NULL ,
                                             constraint JOB_EXEC_PARAMS_FK foreign key (JOB_EXECUTION_ID)
                                                 references BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
) ENGINE=InnoDB;

CREATE TABLE BATCH_STEP_EXECUTION  (
                                       STEP_EXECUTION_ID BIGINT  NOT NULL PRIMARY KEY ,
                                       VERSION BIGINT NOT NULL,
                                       STEP_NAME VARCHAR(100) NOT NULL,
                                       JOB_EXECUTION_ID BIGINT NOT NULL,
                                       CREATE_TIME DATETIME(6) NOT NULL,
                                       START_TIME DATETIME(6) DEFAULT NULL ,
                                       END_TIME DATETIME(6) DEFAULT NULL ,
                                       STATUS VARCHAR(10) ,
                                       COMMIT_COUNT BIGINT ,
                                       READ_COUNT BIGINT ,
                                       FILTER_COUNT BIGINT ,
                                       WRITE_COUNT BIGINT ,
                                       READ_SKIP_COUNT BIGINT ,
                                       WRITE_SKIP_COUNT BIGINT ,
                                       PROCESS_SKIP_COUNT BIGINT ,
                                       ROLLBACK_COUNT BIGINT ,
                                       EXIT_CODE VARCHAR(2500) ,
                                       EXIT_MESSAGE VARCHAR(2500) ,
                                       LAST_UPDATED DATETIME(6),
                                       constraint JOB_EXEC_STEP_FK foreign key (JOB_EXECUTION_ID)
                                           references BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
) ENGINE=InnoDB;

CREATE TABLE BATCH_STEP_EXECUTION_CONTEXT  (
                                               STEP_EXECUTION_ID BIGINT NOT NULL PRIMARY KEY,
                                               SHORT_CONTEXT VARCHAR(2500) NOT NULL,
                                               SERIALIZED_CONTEXT TEXT ,
                                               constraint STEP_EXEC_CTX_FK foreign key (STEP_EXECUTION_ID)
                                                   references BATCH_STEP_EXECUTION(STEP_EXECUTION_ID)
) ENGINE=InnoDB;

CREATE TABLE BATCH_JOB_EXECUTION_CONTEXT  (
                                              JOB_EXECUTION_ID BIGINT NOT NULL PRIMARY KEY,
                                              SHORT_CONTEXT VARCHAR(2500) NOT NULL,
                                              SERIALIZED_CONTEXT TEXT ,
                                              constraint JOB_EXEC_CTX_FK foreign key (JOB_EXECUTION_ID)
                                                  references BATCH_JOB_EXECUTION(JOB_EXECUTION_ID)
) ENGINE=InnoDB;

CREATE TABLE BATCH_STEP_EXECUTION_SEQ (
                                          ID BIGINT NOT NULL,
                                          UNIQUE_KEY CHAR(1) NOT NULL,
                                          constraint UNIQUE_KEY_UN unique (UNIQUE_KEY)
) ENGINE=InnoDB;

INSERT INTO BATCH_STEP_EXECUTION_SEQ (ID, UNIQUE_KEY) select * from (select 0 as ID, '0' as UNIQUE_KEY) as tmp where not exists(select * from BATCH_STEP_EXECUTION_SEQ);

CREATE TABLE BATCH_JOB_EXECUTION_SEQ (
                                         ID BIGINT NOT NULL,
                                         UNIQUE_KEY CHAR(1) NOT NULL,
                                         constraint UNIQUE_KEY_UN unique (UNIQUE_KEY)
) ENGINE=InnoDB;

INSERT INTO BATCH_JOB_EXECUTION_SEQ (ID, UNIQUE_KEY) select * from (select 0 as ID, '0' as UNIQUE_KEY) as tmp where not exists(select * from BATCH_JOB_EXECUTION_SEQ);

CREATE TABLE BATCH_JOB_SEQ (
                               ID BIGINT NOT NULL,
                               UNIQUE_KEY CHAR(1) NOT NULL,
                               constraint UNIQUE_KEY_UN unique (UNIQUE_KEY)
) ENGINE=InnoDB;

INSERT INTO BATCH_JOB_SEQ (ID, UNIQUE_KEY) select * from (select 0 as ID, '0' as UNIQUE_KEY) as tmp where not exists(select * from BATCH_JOB_SEQ);
```

</details>

## 실행방법

- jar 파일 위치로 이동(프로젝트 루트에서 실행)
```sh
cd ./build/libs
```

- 적당한 program argument값을 입력하여, jar파일을 실행합니다.
    - filePath: 대상 csv파일 경로를 입력합니다. 절대경로, 상대경로 둘다 지원합니다.
    - chunkSize: chunk의 단위를 정합니다. 실행 환경의 스펙에 따라 자유롭게 설정하시면 됩니다.
    - version: spring batch job의 version을 입력합니다. filePath와 chunkSize가 같더라도 version이 다른 경우
      job parameter가 다른 job실행으로 인지합니다.
```sh
java -jar assignment-1.0.1.jar filePath={filePath} chunkSize={chunkSize} version={version}
```

* 실행 예시(테스트를 위해 만든 test.csv파일로 실행합니다. 별다른 파일 설정 없이 동작합니다.)
 ```sh
java -jar assignment-1.0.1.jar filePath=../../src/main/resources/test.csv chunkSize=100 version=1
```

## 리소스 설명
- 리소스 파일
  - broken.csv: ParseException을 1회 발생시키도록 변형한 csv파일
  - broken2.csv: ParseException을 12회 발생시키도록 변형한 csv파일
  - empty.csv: 파일이 비어있는 경우를 테스트하기 위해 만든 빈 csv파일
  - test.csv: 테스트를 위한 정상 데이터 파일